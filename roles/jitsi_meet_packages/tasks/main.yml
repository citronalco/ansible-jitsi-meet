- name: Install gpg
  apt:
    pkg: [ "gpg", "gpg-agent" ]
    install_recommends: false
    update_cache: yes

- name: Add apt-key of jisti.org
  apt_key:
    url: "https://download.jitsi.org/jitsi-key.gpg.key"

- name: Add jitsi.org repository
  apt_repository:
    repo: "deb https://download.jitsi.org stable/"
    filename: jitsi

- name: Preconfigure hostname used by postinst scripts of jitsi-meet-prosody package
  debconf:
    name: jitsi-meet-prosody
    question: jitsi-meet-prosody/jvb-hostname
    vtype: string
    value: "{{ inventory_hostname }}"

- name: Preconfigure hostname used by postinst scripts of jitsi-videobridge package
  debconf:
    name: jitsi-videobridge
    question: jitsi-videobridge/jvb-hostname
    vtype: string
    value: "{{ inventory_hostname }}"

- name: Preconfigure password used by postinst scripts of jitsi-videobridge package
  debconf:
    name: jitsi-videobridge
    question: jitsi-videobridge/jvbsecret
    vtype: password
    value: "{{ jvbpwd }}"

- name: Preconfigure coturn password used by postinst scripts of jitsi-meet-prosody package
  debconf:
    name: jitsi-meet-prosody
    question: jitsi-meet-prosody/turn-secret
    vtype: password
    value: "{{ turnpwd }}"

- name: Tell installer to create a self signed certificate
  debconf:
    name: jitsi-meet
    question: jitsi-meet/cert-choice
    vtype: string
    value: "Generate a new self-signed certificate"

- name: Install nginx, openjdk and jisti-meet
  apt:
    pkg: [ "nginx-full", "openjdk-17-jre-headless", "jitsi-meet" ]
    state: latest
    install_recommends: false
